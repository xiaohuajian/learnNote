

[TOC]

# 网络优化

使用无线装置传输数据可能是导致应用出现过度耗电问题的最重要的根源之一。为了最大限度地减轻与网络活动相关的过度耗电问题，您务必要了解连接模式会如何影响底层无线装置硬件。

## 无线装置状态机

处于全面活动状态的无线装置会消耗大量电量，因此该装置会在不同的能量状态之间转换，以便在不使用时节省电量，同时在需要时尝试最大限度地缩短与为无线装置“接通电源”相关的延迟。

典型 3G 网络无线装置的状态机包含 3 种能量状态：

1. **满功率**：在连接处于活动状态时使用，让设备能够以尽可能高的速度传输数据。
2. **低功率**：一种中间状态，所使用的电池电量约为满功率状态下的 50%。
3. **待机**：最低能量状态；处于此状态时，没有网络连接处于活动状态，或不需要网络连接。

虽然低功率和待机状态所消耗的电池电量明显减少，但它们也会导致网络请求严重延迟。从低功率状态返回满功率状态需要大约 1.5 秒，而从待机状态切换到满功率状态需要大约 2 秒。

为了最大限度地缩短延迟，状态机利用延迟来推迟向低能量状态的转换。图 1 使用的是 AT&T 的典型 3G 无线装置的时间设置。

![mobile_radio_state_machine](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggi9d41yj5j30ja05iq39.jpg)

**图 1.** 典型的 3G 无线装置状态机。

## 应用会如何影响无线装置状态机

每次您创建新的网络连接时，无线装置都会转换为满功率状态。如果是上述典型 3G 无线装置状态机，它会在传输期间以及额外 5 秒的拖尾时间内始终保持满功率状态，并在随后的 12 秒内保持低能量状态。因此，对于典型的 3G 设备，每个数据传输会话都会导致无线装置消耗能量近 20 秒。

在实践中，如果某个应用每 18 秒传输一次非整合数据并持续 1 秒，就会导致无线装置在即将进入待机模式时重新切换回高功率状态，进而永久保持活动状态。因此，它每分钟有 18 秒以高功率状态消耗电池电量，并在剩余的 42 秒内以低功率状态消耗电池电量。

相比之下，如果同一款应用每分钟进行 3 秒的整合传输，无线装置保持高功率状态的时间就只有 8 秒，而保持低功率状态的时间只有额外的 12 秒。

第 2 个示例使无线装置每分钟有额外的 40 秒时间处于待机状态，从而大大减少电池耗电量。



![graphs](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggi9e29t9xj30j007iglo.jpg)

**图 2.** 整合传输和非整合传输的无线装置耗电量对比情况。

## 压缩数据

减少通过网络连接发送或接收的数据量后，连接时长也会相应缩短，从而节省电池电量

## 分析应用网络流量

移动设备上，启动无线装置来发送或接收数据，以及让移动无线装置长时间保持活动状态，都会产生巨大的成本。应该集中请求数据，让设备终端机连接，让无线电可以切换到低功耗待机模式，此应用的网络访问行为可能会导致无线装置长时间处于开启状态，降低了电池效率。

![suboptimal_network_traffic_pattern](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggi9esk5g7j30yb0cndij.jpg)

![optimal_network_traffic_pattern](https://tva1.sinaimg.cn/large/007S8ZIlgy1ggi9eihvqkj30y40ckdi5.jpg)

图2从应用中测量的电池效率高的网络活动。

### 网络流量消耗与耗电量关系

如果数据连接一直保持着激活的状态，那么它的耗电量是很惊人的，所以手机会在网络空闲的情况下自动休眠数据连接来达到省电的目的。以3G网络来举例，它有三个不同的状态：

​    Full power: 全力工作，网络信号和电量的消耗都很高。

​    Low power:耗电量是Full power的一半，当然信号也差一些。

​    Standby: 耗电量很少，相当于休眠了。

​    手机会根据当前网络的使用情况来进行状态的切换，如下图所示，这就是无线网络的状态机。当处于Full Power状态空闲5秒后就会进入到Low Power状态，如果还空闲12秒则进入到Standby状态。而从Standby状态重新切换到Full Power状态则需要2秒的延迟，从Low Power状态则需要1.5秒。理解这个状态机就可以很好地理解怎么在传输网络数据的时候更省电。

当用户通过您的应用执行特定活动时，用户发起的网络活动可能会高效地组合在一起，而当用户请求应用需要获取的额外信息时，用户发起的网络活动则会分布不均。分析用户发起的网络流量的目标是查找在一段时间内频繁使用网络的模式，并尝试创建或延长不访问网络的时间段。

## 复用连接和清除闲置连接

这个功能拿okhttp 来说就是dispatcher ，内部维护了一个线程池，这个线程池就是来进行连接复用以及清除闲置连接的；比如说，keep-alive 意思保持长连接，说说这个字段的含义？

传统的Http应用里都是一次TCP连接一次request。而每次建立tcp 连接耗费资源很大的，所以这样效率很低，基于这样的背景下，http1.1 协议里增加了 keepalive的支持， 并且默认开启。客户端和服务端在建立连接并完成request后并不会立即断开TCP连接，而是在下次request来临时复用这次TCP连接。但是这里也必须要有TCP连接的timeout时间限制，一般是2个小时。不然会造成服务端端口被长期占用释放不了。这个就是复用的意思。

但并非keep-alive的timeout设置时间越长，就越能提升性能。长久不关闭会造成过多的僵尸连接和泄露连接出现。——这就是清除闲置连接，并且okhttp对一个host 最多连接5个线程。



## 批量处理网络请求

在移动设备上，打开无线装置、建立连接并让无线装置保持唤醒的过程会耗费很多电量。因此，随机处理各个请求会消耗大量电量并缩短电池续航时间。更高效的方法是将一组网络请求排入队列并一起处理。这样，系统只需付出一次打开无线装置的电力成本，但仍能获得应用请求的全部数据。这个和tcp连接复用有些相似。使用的场景就是：分页拉取数据时，根据item的高度设置每一页拉取的数量，避免用户上下滑动时，多次请求。

使用网络访问调度程序 API 对应用数据请求进行排队和处理可显著提高应用的用电效率。调度程序将请求分组在一起以供系统处理，从而节省电池电量。

## 推送

避免轮询，通过推送。因为轮询会耗费大量的流量和电量；



### 使用facebook 的网络优化库



网络优化措施参考：https://www.jianshu.com/p/beab0b5b3615

https://www.jianshu.com/p/8fbc97c4e756

https://android.jlelse.eu/designing-android-apps-to-handle-slow-network-speed-dedc04119aac



## 布局优化

### stubview

<!-- 参考资料 ：-->

其实这个stubview 的应用场景就是在某个界面，有几种逻辑对应某几个界面，比如一般的获取网络的界面就会有数据获取正常，获取失败、没有网络等情况，假如说其布局差别很大，然后无网络、没有网络等情况下出现的不多，这时候就可以用stubview 把一些不多的情况界面包起来，等出现了无网络、或者请求失败后在inflator 这些布局。同时，当我们inflator 后，得到了一个view，==这个view后续的可见性可以通过Gone、visiable 去控制，网上说的stubview 只能inflator 一次，确实没有错，但是不代码这个inflator 出来的view不能进行Gone、visiable 去控制可见性与否了，这一点我一直都有疑惑，总算自己测试才搞明白了==。

