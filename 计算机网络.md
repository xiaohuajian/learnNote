# 概述

## 1.1 互联网概述

计算机网络由若干 **结点** 和 连接这些结点的 **链路**组成；网络把许多计算机连接在一起，而互联网则把许多网络通过路由器连接在一起，与网络相连的计算机称为**主机**。

### 1.1.1 互联网组成

互联网的拓扑结构很复杂，但可以划分为两大块：

**边缘部分** 由所有连接在互联网的主机组成。是用户直接使用的，用来通信、资源共享。

**核心部分** 由大量网络和连接网络的路由器组成，为边缘部分提供服务的。

### 1.1.2 边缘部分

边缘部分的主机间通信通常有两种方式：

- 客户端——服务端 client-server ：客户端发出请求，服务端响应并做出回应
- p2p per-two-per ：每个主机充当客户端，也充当服务端，可支持大量用户同时工作

### 1.1.2 核心部分

路由器router 是一种专用计算机，实现**分组交换** 功能。

**电路交换**

如同电话刚发明时，必须让通话双方进行直接物理网络连接，然后通话。其特点必须要有独立的物理通路，而且通话期间占用全部的通信资源，效率低。

**分组交换**

其核心是存储转发。

![20190610230449390](../../Desktop/20190610230449390.png)

 把要发送的数据称为**报文**，在发送报文之前，先把较长的报文划分成为一个个更小的等长**数据段**。在每一个数据段前面，加上一些由必要的控制信息组成的==首部(header)==，就构成了一个==分组(packet)==。**分组是在互联网中传送数据的单元**。分组中的首部包含了诸如目的地址和源地址等重要控制信息，每一个分组才能在互联网中独立地选择传送路径，并被正确地交付到分组传输的终点。

_**主机是为用户进行信息处理的，可以和其他主机通过网络交换信息。路由器是分组转发。**_

分组交换的优点：

            1.高效：动态分配传输带宽，对通信链路是逐段占用
    
            2.灵活：分组独立选择合适的路由
    
            3.迅速：可以不建立连接就能向其他主机发送数据
    
            4.可靠：保证可靠的网络协议；分布式多路由的分组交换网，使网络有很好的生存性


## 1.2计算机网络的性能

### 速率

单位时间内传输的数据量  。以比特bit 来衡量信息量时，就是 bp/s 或 bps bit per second ，以kb来衡量，就是kbps，依次类推

### 带宽

在计算机网络中，带宽用来表示网络的通信线路所能传送数据的能力，因此网络带宽表示在单位时间内从网络中的某一点到另一点所能通过的“最高数据率 （在其他地方，带宽有不同的含义）单位是b/s ，kb/s， Mb/s， Gb/s

### 吞吐量

吞吐量表示在单位时间内通过某个网络（或信道、接口）的数据量。吞吐量更经常地用于对现实世界中的网络的一种测量，以便知道实际上到底有多少数据量能够通过网络。 吞吐量受网络的带宽或网络的额定速率的限制，不同的时间测试可能结果不一致。 单位b/s， Mb/s

### 时延

时延是指数据（一个报文或分组，甚至比特）从网络（或链路）的一端传送到另一端所需的时间。时延是个很重要的性能指标，网络中的时延是由以下几个不同的部分组成的。

#### 发送时延

主机或路由器发送数据所需要的时间，从发送的第一个比特算起到最后一个比特结束所需时间。
$$
发送时延 = 数据长度 / 发送速率
$$

#### 传播时延

电磁波在信道中传播一定的距离需要花费的时间。一般真空中为光速，在电缆中为2.3 * 10^5^, 所以距离比较远时，传播也是需要耗时的；

#### 处理时延

主机或路由器在收到分组时要花费一定时间进行处理，分析、提取数据等

#### 排队时延

分组在网络传输时经过许多路由器，若同一时间有多个分组需要转发时，就会出现排队等待处理，这个过程也会耗时；



### 时延带宽积

时延带宽积=传播时延×带宽， 其含义就是发送端一直发送数据，当一个比特到达终点时，发送端发送的数据量；而这些数据量其实都在链路上，因此称链路的时延带宽积为 **以比特为单位的链路长度**

### 往返时间 RTT

在计算机网络中，往返时间也是一个重要的性能指标，它表示从发送方发送数据开始，到发送方收到来自接收方的确认（接受方收到数据后便立即发送确认）总共经历的时间。当使用卫星通信时，往返时间（RTT）相对较长。



## 1.3计算机网络体系结构

计算机的网络结构大致有三种划分方式，有OSI 体系（七层）、TCP/IP 体系、五层协议。网络体系是一个极其复杂的系统，设计时必须考虑很多东西，比如可扩展、兼容、能够处理各种异常、统一等等。他们的主要功能有

- 差错控制——通信可靠
- 流程控制——发送端的发送速率需要控制，不要太快
- 分段和重装——发送端将要发送的数据块划分为更小的单位，接收方复原
- 复用和分用——发送端的高层回话复用一条底层的连接，接受端在进行分用
- 连接建立和释放——数据交换前要建立连接，完成后要释放

### 简单介绍

OSI 的设计不是很成功，比较复杂、也不实用，实际中更多的使用TCP/IP 。TCP/IP是一个只有四层的体系结构，包含应用层、运输层、网际层、网络接口层；还有一种是原理体系结构层（五层），分为应用、运输、网络、数据链路、物理层，它综合了OSI 和TCP/IP的优点。

![计算机网络体系结构](https://tva1.sinaimg.cn/large/007S8ZIlly1giqi5lmeklj31400u0n11.jpg)



### 应用层

体系中的最高层，任务是通过应用进程间的交互来完成特定网络应用。应用层协议是**应用进程间通信和交互规则。** 进程指的是主机中的程序，比如域名系统DNS，万维网的http协议、邮件的SMTP、文件的FTP等等



### 运输层

运输层负责向两台主机中进程之间的通信提供通用的数据传输服务。主机的多个进程可以复用同一个运输层服务，因为运输层有复用和分用的功能，而分用就是把运输层的信息交付到上面的应用层。

运输层有两种协议：TCP、UDP

TCP传输控制协议：提供面向连接的、可靠的数据传输服务，其数据传输的单位是报文段

UDP用户数据协议报：提供无连接、不可靠的传输服务。

### 网络层

网络层负责不同的主机提供服务，把运输层产生的报文段或用户数据包进行**分组或包**进行传送。也把网络层的分组或包称为 **IP数据报**，这一层针对的主体是边缘部分的主机，是采用无连接的网际协议IP，也叫网络层为IP层。

### 数据链路层

负责把网络层中IP数据报 组装为 帧 （包含数据和控制信息——地址信息、差错控制等等），相当于在网络层的传输过来的数据上添加了一些控制信息，比如说控制信息中的地址信息就是告诉接收端知道从哪个比特开始到哪个比特结束。这样在收到帧时，可以顺利解析出数据报给网络层。差错控制是检测有没有错误的帧，有错误后便丢弃，防止继续传输占用资源。

### 物理层

把数据链路层的帧 信息 （比特 0 和1 ）转换为实际传输物理量，对应实际的电压高低电平 ，具体高低电平怎么传输就不需要深究了，这些是电路知识点，和电气相关。

![数据在各层的传递](../../Desktop/数据在各层的传递.jpeg)



这幅图描述了主机间的通信。主机1 点进程ap1 向主机2 点进程ap2 传送数据。ap1 先将数据交给主机1 点第五层，加上必要的控制信息h5 变成了下一层的分组（数据单元），第四层收到这个数据单元后，加上本层的控制信息h4，在交给第三层ip网络层，以此类推，到第二层 数据链路层，控制信息被加到本层的数据单元的首部和尾部，而第一层物理层不需加控制信息。然后从首部依次传送比特流。

当这一串的比特流离开主机1 经网络媒介传输到路由器时，就从路由器的第一层上升到第三层。每一次根据控制信息进行相关操作，然后将控制信息剥去，交给上一层处理，当到了第三层时，就根据首部中的目的地址查找路由器中的转发表，在传递给第二层，在加上新的首部和尾部后，再到第一层，最后在物理媒介上吧每一个比特发出去。

经过路由器的多次转发，到达主机2，主机2就从第一层到第五层，依次向上，解析相关数据，最终把数据交给应用层，这样就完成了数据传送。

**中间会经过网络核心部分的路由器进行多次转发，才能到达主机2**

![TCP:IP四层协议](https://tva1.sinaimg.cn/large/007S8ZIlly1giqi558rqbj31400u0dir.jpg)



![IP](https://tva1.sinaimg.cn/large/007S8ZIlly1giqi59q1txj31400u00vg.jpg)

# 物理层

物理层的作用是尽可能的屏蔽掉这些传输媒体和通信手段的差异，使物理层上面的链路层感觉不到这些差异，使数据链路层只需要考虑如何完成本层的协议和服务，不必考虑具体的传输媒体和通信手段。

物理层的协议（规程）的特性包含：

- 机械特性：接口所用接线器的形状和尺寸、引脚数目和排列等等
- 电气特性：接口电缆的各条线的电压、电流等
- 功能特性：
- 过程特性：不同功能的的各种可能事件的发生顺序

### 数据通信的基础知识

一个通信系统大致分为三个部分：**源系统（发送端）、传输系统、目的系统（接收端）**；

源系统一般分为两部分：

- 源点：源点设备产生的数据，比如计算机的键盘输入汉字；
- 发送器：源点生成的数字比特流要通过发送器编码后才能在传输系统中进行传输。典型的发送器是调制器。

目的系统也包括两部分：

- 接收器：把传输系统传送过来的信号转换为目的设备能够接收的信息的设备，即**调制器**。
- 终点：终点设备

传输系统一般有两种信号，模拟信号和数字信号。

#### 信道

表示向某一个方向传送信息的媒体。一条通信电路往往包含一条发送信道和一条接收信道。从**信道的双方信息交互方式**来看，有三种方式：

1. 单向通信：也叫单工通信；就是只能有一个方向的通信没有反方向的通信；
2. 双向交替通信：半双工通信——双方都可以发送信息，但同一时间只能允许一方发送信息；
3. 双向同时通信：全双工通信——双方都可以发送信息，且同一时间都能发送信息；

### 信道复用

常用的信道复用技术有 频分复用、时分复用、统计时分复用、码分复用和波分复用

# 数据链路层

数据链路层属于网络的低层，常用的信道有两种类型：

1. **点对点信道**：使用一对一通信方式
2. **广播信道**：一对多广播方式，过程复杂。

本章主要掌握：

- 两种信道的特点，以及这两种信道使用的协议特点。
- 数据链路层的三个基本问题：封装成帧、透明传输、差错检测
- 以太网的mac层的硬件地址
- 适配器、转发器、集线器、网桥、以太网交换机的作用以及场合

数据链路层的在网络通信的地位：

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1genn7dsjjxj31400u0427.jpg" alt="数据链路层的地位" style="zoom:67%;" />



## 3.1 点对点信道

数据链路层的协议数据单元——帧。其把网络层交下来的数据构成**帧**发送到链路上，以及把接收到的帧中的数据取出交给网络层，下面采用三层模型，网络层、数据链路层、物理层来分分析：

![点对点信道](https://tva1.sinaimg.cn/large/007S8ZIlgy1genndv2duij31400u00w0.jpg)



点对点信道的链路层通信流程，从上图看到其作用是：

1. 结点A数据链路层把网络层下来的IP数据报添加首部和尾部封装为帧
2. 结点A 把数据单元 帧 发送给B
3. 若结点B 收到的帧无差错，则从收到的帧中提取IP数据交给网络层，否则丢弃。

### 3.1.1 三个基本问题

#### 封装成帧

在一段数据（网络层的数据包）前后分别添加首部和尾部，就构成了一个帧。接收端在收到物理层上交的比特流后，根据首部和尾部的标记，提取出帧。**这样我们就知道，这是一个可逆的过程，封装成帧——由网络层到数据链路层；还原成帧——由物理层到数据链路层。** 

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gennre8gndj31400u0tcu.jpg" alt="封装成帧" style="zoom:67%;" />

为了提高传输效率，就会让数据部分远远大于帧的首尾部，但是有最大传输长度——**最大传送单元 MTU**：帧的数据部分长度。

一般的，帧首尾部都是一些特定的字符，这些特定的字符就是**帧定界**，而使用哪些字符和我们传送的数据格式有关，比如传送的为ASCII纯文本文件，ASCII 是7位编码，可组成128个字符，可以打印的有95个，不可打印的字符有33。这时候我们可以用这字符去充当帧定界符来区分不同帧的开始和结束，解析的时候也根据这些定界符来划分。比如用 SOH （start of header ） 和 EOH （end of header）来充当帧首、帧尾的定界符



![帧定界符](https://tva1.sinaimg.cn/large/007S8ZIlgy1geno5itvncj31p40mmgpu.jpg)

#### 透明传输

如果我们的传输内容中含有字符和界定符一样的话，那么在解析还原的时候必定会产生错误，为了避免这样的情况，我们需要想到一些办法解决这个问题，就是在 SOH、EOH 帧定界符前面加入转义字符 “ESC” ，这样的方法称为 **“字节填充”** 。

![字节填充](https://tva1.sinaimg.cn/large/007S8ZIlgy1genoc3ulnij31400u00vy.jpg)

#### 差错检测

在物理层中比特传输中可能会产生差错（**比特差错**），0 和 1替换，这时候我们需要在接受端进行数据检验，看我们的数据是否正确，那如何做到呢？

**循环冗余检验**：就是把数据先分组，然后在每组后面添加若干位冗余码（无用的数据），具体如何实现可以具体研究相关算法。

注意这种CRC 循环冗余检验只能做到对 帧的无差错接收——即接收到的每个帧都是正确的，但是还有一种情况就是出现帧丢失、帧重复（**传输差错**）这种情况，这种循环冗余检验就无法解决这类问题。如何解决呢？

通过增加 **帧序号、确认、重传机制** 解决传输差错，当接收端收到正确的帧就要向发送端发送确认，发送端若一段时间内没有收到就认为出错，进行重新发送。后来这种重传确认机制移到运输层 TCP/IP 层去完成，不在保证传输可靠，后面根据网络情况好坏采用不同的机制提升传输效率。

### 3.1.2 点对点协议 PPP

PPP协议的特点就是上面点对点的一些特性，简单、封装成帧、差错检测、透明传输、最大传输单元。想要深究其原理可以探究，就不在深入讨论。



## 3.2 广播信道

广播信道可以进行一对多通信，局域网（局域网是一个动态范围的概念，其范围可大可小）就是使用广播信道。同样的，这里也有信道复用的概念，信道复用可以静态（频分、波分、时分），也可以动态媒体（随机接入、受控接入）接入控制。

现在局域网的标准大多按以太网的标准。

### 3.2.1 网络适配器

计算机怎样连接到局域网上的呢？

显然，就是靠的计算机主机上一个网卡（网络接口卡），更准确的叫**网络适配器**，适配器工作在物理层和数据链路层，计算机发送IP数据报时，就由协议栈吧数据向下交给适配器，主装成帧后发送到局域网。适配器接收到正确的帧后，交给网络层。



![适配器](https://tva1.sinaimg.cn/large/007S8ZIlgy1genqet5r6bj31400u0jug.jpg)



### 3.2.2 CSMA/CD 协议

最早的以太网将许多主机连接在一根总线上，这样会存在一个问题，采用广播方式，一台主机发送数据，其他的主机都能知道，为了避免这种情况产生，达到一对一通信，在适配器中添加地址，和帧首部的地址进行比较，一致时才进行接收。

同时，在传输时，如何保证数据不发生碰撞？如何协调的工作。

为了解决上述问题，采用了CSMA/CD协议，其主要作用为：

1. 准备发送：适配器从网络层获取一个分组，加上以太网首部和尾部，组成以太帧，放入适配器缓存中。发送前，必须检查信道。
2. 检查信道：若检测到信道忙，则应不停的检测，一直等待信道转为空闲。若检测到信道空闲，并在96比特时间内信道保持空闲（保证帧间最小间隔），就发送这个帧。
3. 在发送过程中仍不停地检测信道，即网络适配器要 **边发送边监听**。则会出现发送成功，回到1，发送失败，停止发送，发送规定的干扰信号，适配器执行避退算法，等待一定时间，在返回2

### 3.2.3 Mac地址

适配器地址就是Mac地址或者 硬件地址，这个地址是IEEE组织分配管理的，任何要生产网络适配器的厂商都需要向该组织购买。Mac地址实际是6字节（48位），最多有2的48次方个地址。该地址在生产产品时被写入硬件中，不能修改。记住mac地址不是ip地址，二者不是一个东西，二者的关系下一章讲解。



# 网络层

本章重点需要掌握：

- 虚拟互联网络的概念
- IP地址与物理地址的关系
- 传统的分类的IP地址和无分类域路由选择
- 路由选择协议的工作原理

## 4.1网络的两种服务

讨论在通信中，可靠交付应当由谁负责？是**网络还是端系统？**，回答这个问题就是类比之前的电信网络通信，电信网络采用的是面向连接（通信之前要先建立一条虚拟连接）的可靠交付，其端无需处理差错。在计算机网络中，网络层**==不提供服务质量的保证==**，就是无连接的、不可靠的交付数据。

我们先来比较一下传统电信通信和计算机通信采用不同的实现思路？

|               | 虚电路服务                                         | 数据报服务                                     |
| ------------- | -------------------------------------------------- | ---------------------------------------------- |
| 思路          | 可靠通信由网络保障                                 | 由用户主机保证                                 |
| 链接建立      | 必须建立（通信前）                                 | 不必建立                                       |
| 分组转发/顺序 | 属于同一虚拟电路的按照同一路由转发；按发送顺序到达 | 每个分组独立自由转发；到达顺序不一定按发送顺序 |
| 差错处理      | 网络或主机负责                                     | 主机负责                                       |

## 4.2 网际协议IP

一般的，我们在链接网络时，要使用一些中间设备，有以下几种分类：

1. 物理层使用的设备叫转发器；
2. 数据链路层使用的中间设备叫网桥
3. 网络层的叫路由器；
4. 网络层以上的使用的中间设备叫网关

### 4.2.1分类的IP地址表示方法

IP地址就是给互联网中每一台主机分配一个在全世界范围内的唯一32位的标识符；所谓分类的ip 就是将IP地址划分为若干个固定类，我们经常会听到A 类、B类、C类、D类、E类等网络，这些ip地址 由两个字段组成 ==网络号和主机号==；

> 网络号在整个互联网范围内都是唯一的；
>
> 主机号在它前面的网络号所指明的网络范围内是唯一的；

这样一来，ip就在**整个互联网范围内唯一**； IP= {网络号，主机号}

![551591892597_.pic](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfot9ccf9lj31400u0wiz.jpg)



一般的，ip地址都是32位，我们用点分十进制表示 比如 10000000 00001011 00000011 00011111 可以写为128.11.3.31 ，因为后者好记和表达。

### A 类 B类 C类地址分类

A类：

从上面的图看到A类地址 网络号 8位比特，主机号 24位；网络号的第一位已经固定是0 ，则网络号只有7位可用，所以共有 2^7^ 可用，==注意，当网络号全为0 为保留地址，是本网络；网络号为 01111111 （全1）即 127 表示本地测试地址，当我们用 127.0.0.1 表示该报文不会发到网络中。==所以，真正的网络号为 2^7^ -2 , 主机号为2^24^ - 2 (这里主机号减2 道理差不多)，整个A类可以表示的ip地址数量约为 2^31^ , 而整个ip地址数量为 2^24^ 所以A 类地址占50% 。

B 类

分析和A类一样，知道网络号2个字节，固定为两位10(**所以这个类的地址最少是128开头**)，还剩14位，因为有固定位10，不会出现全0或1。但128.0.0 不会指派，要从128.1.0 开始，所以网络号有2^14^ - 1；而主机号16位，要考虑全0或1，需要减2，则主机号有2^16^ -2 ; 总的约有 2^30^，

C 类

分析一样，网络号3个字节，固定3位110（**所以这个类的地址最少是128开头**），网络号有2^21^，另外192.0.0也是不指派，从192.0.1 开始；最大主机数有2^8^ - 2 ；整个地址空间有2^29^. 

![image-20200613190022835](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfqv5sn1mxj31400u04qp.jpg)



ip地址的特点和一些概念：

- 在同一个网络号下的主机，我们说他们是同一个网段，每一个主机都是平等的；
- 路由器因为是链接两个不同的网络，所以至少有两个或以上的ip地址；
- ip分级的好处：
  - ip地址管理机构就只用看网络号，不用管主机号。减少查找和分配内存

### IP 地址与硬件地址

硬件地址是无法改变的，出厂就固定的；ip地址是一个逻辑地址；ip地址是给**网络层及其上层使用的**，硬件地址是**链路层及以下使用**

![image-20200613193214078](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfqw2wamf7j31400u0e81.jpg)

发送数据时，数据从上向下，使用ip地址的数据报交给数据链路层，会被封装成mac 帧，这个mac 在发送时使用的就是硬件地址。ip地址和mac地址都是放在数据首部。前面说到路由器要连接不同的网络具有两个或多个ip地址，同理，在转发数据时也必须具备两个硬件地址

![image-20200613193844410](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfqw9qcm15j31400u0e81.jpg)

### 地址解析协议ARP

问：如何通过ip地址找到对应的硬件地址呢？

解决这个问题就是通过ARP协议。假如主机A要同局域网的B发送数据，就在其ARP高速缓存中查找，找到了就把地址写入mac帧，在发送，找不到就按照下面步骤进行：

1. ARP 发送一个广播，内容：我IP时209.0.0.1 ，硬件地址00--00-C0-12-12-A3，我想知道IP为201.0.0.2的主机硬件地址“
2. 本局域网内的所有主机都收到这个请求，并查看其IP是否和目的ip一致，假如B 是目的ip，这时候B就回应内容”我的IP地址是209.0.0.2，硬件地址是00--00-C0-12-12-A6“，并把A的IP地址和硬件地址的映射写入缓存，未来后续可能自己向A发送内容。
3. A收到后，就把地址写入mac帧并发送请求。



ARP 的几种情况：

![image-20200613195807141](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfqwttg5ccj30u0140b29.jpg)

### IP数据报格式

![image-20200613224256379](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfr1lbke7hj31400u04qp.jpg)

ip数据报首部的字段

1. 版本 ：ipv4 或ipv6
2. 首部长度：占4位
3. 区分服务：
4. 总长度：首部+数据长度，数据链路层也有最大长度MTU。
5. 标识：内部有一个计数器，每产生一个数据报计数器加1，这个标识不是序号，因为数据分片后，通过这个标识就可以最后组装起来。
6. 标志：MF、DF
7. 片偏移：数据分片后，较分片前的相对位置；
8. 生存时间：防止无法交付的数据无限制的在网络中兜圈子。其原理是内部有一个计数器，每经过一个路由器且消耗时间小于1s就减1，减到0就丢弃。
9. 协议：指出数据报携带的数据使用的是什么协议，然后交给对应的协议去处理；比如是TCP、UDP等。
   
10. 首部检验和：只检验数据报的首部，不包括数据部分。就是发送分把首部不划分许多16位的序列，把检验字段置0，用反码算术吧所有16位相加，接收方在用反码在计算一次，得出结果0说明数据没有变化，否则数据发生错误，则把数据丢弃。
11. 源地址：32位
12. 目的地址：32位
13. 数据可变部分：这是可选字段，主要用来支持排错、测量以及安全的措施。

### IP层转发分组

IP转发是基于网络组来转发的，不是基于主机来的——**从一个路由器转发到下一个路由器**。举例：在图4-12中，H1主机要经过网1、R1、网2、R2、主机H3. 当到达某个路由器时（R2），若目的主机在路由器连接到的网络（网1、网2），就能直接交付；否则要经过下一跳转发。

**默认转发** 

> 百度百科 ： 是对IP[数据包](https://baike.baidu.com/item/数据包)中的目的地址找不到存在的其他路由时，[路由器](https://baike.baidu.com/item/路由器)所选择的路由。目的地不在路由器的[路由表](https://baike.baidu.com/item/路由表)里的所有数据包都会使用默认路由。这条[路由](https://baike.baidu.com/item/路由)一般会连去另一个路由器，而这个路由器也同样处理数据包: 如果知道应该怎么路由这个数据包，则数据包会被转发到已知的路由；否则，数据包会被转发到默认路由，从而到达另一个路由器。每次转发，路由都增加了一跳的距离。

![image-20200613232611327](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfr2ubkcifj31400u04qp.jpg)

假如一个较小的网络（上图4-17），链接在N1网络上的主机只需要3个项目，第一个是N1网络直接交付，不用转发。第二个就是N2，要通过R2转发，第三个R1就是默认路由，只要不是N1和N2，通通走R1，这样就减少搜索时间和路由表空间。

**这个默认路由非常重要，其概念，可以说没有这个默认路由，就无法实现路由转发**

**分组算法**

![image-20200613233136017](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfr2zy78kpj30qi0f0kaq.jpg)

注意：

有一点要明白，当目的地址A，经过路由器R时，只要不是明确指出项目（就像上面指出N1和N2），就走默认路由。这样就能保证这一步路由一定是对的。经过n次之后，一定会在某个路由器上找到明确项目，这样就会找到最终目的地址。==好好体会这一点，明白这一点就明白了整个路由机制，这一点非常关键，否则你会认为当某个网络有多个路由时，每个路由点都进行转发，然后每个路由都往下走，最终形成了一个巨大的网络，会造成巨大的资源浪费。这样就会造成想不通的局面==。

## 4.3 划分子网和构造超网

### 子网掩码

定义：在之前的两级ip地址上加了一个字段——子网号字段——变成三级地址，这样其ip表达变为

**Ip地址 = {网络号，子网号，主机号}**

子网号是从之前的两级ip地址中的主机号地址拿出一部分作为子网号，其实整个地址并没有增多，反而减少了（因为要考虑全0或1 的情况）。

**划分子网优点**

减少路由表的空间，增加灵活性；因为可以通过子网号进行一次分级，相当于比之前的网络号在多了一次分级。

**如何确定子网号的网络地址呢？**

一般的，对目的网络地址和子网掩码 逐位相与 AND 会得到子网号。把这个子网号与路由表缓存的数据进行比较查找是否有相同的地址，有就进行转发，否则到其他路由。在二级分类地址中A、B、C类地址对应默认的子网掩码为：

A ： 255.0.0.0 ；

B：255.255.0.0

C：255.255.255.0

看到这里是不是很熟悉，打开电脑

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfssynqbuoj30n40ushdv.jpg" alt="image-20200615111528172" style="zoom:50%;" />

**子网分组转发流程**

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfst03g1igj30n40hcaqe.jpg" alt="image-20200615111650666" style="zoom:50%;" />

**无分类编址**

网络前缀：去除之前的A、B、C类的分组方法。

Ip = 128.14.35.7/20=**10000000 00001110 0010**0011 000000111 

即前20位是网络号，后面的12位是主机号，这样的斜线记法中，斜线后面的数字就是地址掩码1的个数。上面的地址其子网掩码为 11111111 11111111 11110000 00000000.



**最长前缀匹配**

当子网中有多个可以匹配网络地址的路由时，应该选择路径最长的网络前缀的路由，这样可以减少网络范围，因为斜线后面的数字越大，说明主机数越少，范围就越小，路由就越具体，更容易。

 

### ICMP

作用：用于在主机与路由器之间传递控制信息，包括报告错误、交换受限控制和状态信息。为了提高转发交付的成功率，采用了ICMP协议，其应用例子 就是 ping hostname ，我们测试两个网络通不通往往会采用这个方式来，其实就是通过ICMP协议完成的；tracert 用来显示到达目的主机的路径。



报文种类：

差错报告报文

询问报文 

### 路由算法和协议

#### 路由结构

![image-20200615221945515](https://tva1.sinaimg.cn/large/007S8ZIlgy1gftc5v077oj31400u0hdt.jpg)



输入端和输出端：

![image-20200615222131093](https://tva1.sinaimg.cn/large/007S8ZIlgy1gftc7nglbrj30u0140e81.jpg)



## 4.4 IPV6

128位长度，采用冒号分16进制的方法分组，这样就有了差不多8个16进制的数通过冒号连接起来了。1F：22: 0:0: 34:AB：1: 2A 就是一个ipv6的地址，解决ipv4不够使用的场景设计。



# 运输层

掌握点：

- 运输层为进程提供逻辑通信

- 端口和套接字
- UDP
- 面向连接的TCP
- 在不可靠网络上实现可靠传输工作原理
- TCP 的滑动窗口、流量控制、拥赛控制及连接管理

## 协议概述

运输层向它上面的应用层提供通信服务，面向通信的最高层，也是用户功能的最低层。**网络层为主机之间的提供逻辑通信，运输层为主机中进程提供端到端的逻辑通信。**

运输层有两种协议tcp和udp，其各种应用如下：

![image-20200615234341035](https://tva1.sinaimg.cn/large/007S8ZIlgy1gftel5cbzwj30u0140e81.jpg)

### 端口

当数据发到目的主机后，如何找到对应的进程呢？

我们可以用特定的标识符来区分，但是不同操作系统的标识符不一样，这个问题就不好处理，于是就规定用统一 **端口**区分。端口是一个16位（2字节）的二进制表示，可以表达65535 个端口，即这么多应用程序，对于计算机来说够用了。也可以理解为 应用层的各种协议进程与运输尸体进行层间交互的一种地址。

常用应用程序规定的端口：

| 程序     | FTP  | DNS  | HTTP | HTTPS |
| -------- | ---- | ---- | ---- | ----- |
| 熟知端口 | 21   | 53   | 80   | 443   |



## UDP

UDP 就是在IP数据报的基础上加了一个差错检测（CRC算法，求反码）的功能。

### 主要特点

1. 无连接——发送数据前，不要连接
2. 不可靠交付
3. 面向报文——对应用程序发送的报文，添加首部后即交给ip层，不合并也不拆分。
4. 无拥赛机制——有时侯需要减少数据丢失，会引入纠错或重传机制
5. 支持一对一、多；多对一、多；
6. 首部开销小——只有8字节

UDP 单播、多播、广播

单播： 一对一通信（局域网内）；

多播：一对多通信（局域网内特定的一组主机）；

广播：一对全部 （局域网内所有主机）；

### 首部特点

源端口、目的端口、长度、检验和

## TCP 概述

特点：

1. 面向连接。发送数据前要先连接，发送完后，释放连接
2. 可靠交付。数据无差错、不丢失、不重复，且按序到达
3. 全双工通信

TCP 连接

tcp 连接的两个端点是套接字。套接字 socket = （ip地址：端口号）

## 可靠传输原理

要实现可靠传输，必须有两个条件：发现错误后，重新传输；接受方来不及接收时，让发送方降低发送速度；

### 停止等待协议

发送方A 向接受方B发送分组，B收到后向A发送确认信息，这样A收到B的确认消息后就知道此次的信息发送成功。假如A在发送中信息没有到达B，或者B在发送确认信息时没有达到A，A就无法知道是否发送成功，如何解决？引入超时机制，当A发送分组后，开始计时，一定时间内未收到B的确认消息，则认为发送失败，失败后重新发送刚刚的分组。

![image-20200616233447984](https://tva1.sinaimg.cn/large/007S8ZIlgy1gfujy8urokj31400u0b29.jpg)

总结上面过程，有以下特点：

1 A发送分组后，要保留一段时间A的副本，当收到B的确认才清除副本；

2 分组和确认分组都要进行编号，这样才能确认哪一个分组发送成功；

3 超时时间的设定问题——应当比分组传输的平均往返时间更长一些。（因为有些分组可能在信号不好时比一般平均往返时间长）。超时时间太长，影响效率；太短，造成很多没必要的重传。

### 连续ARQ 协议

如果每次都只发送一个分组，在等到确认分组后，在发送下一个分组，可能导致通道利用率低，这时候采用连续发送固定数量的分组提升效率，确认也用累积确认的方式。即ARQ协议

![image-20200616233756072](https://tva1.sinaimg.cn/large/007S8ZIlly1giqi80r7a4j31400u0b29.jpg)



## TCP 报文首部格式

tcp的首部各字段表达其全部功能，其首部字段固定20个字节，后面有4n个可选项字段：

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gfuk7p3wr8j31400u0b29.jpg" alt="image-20200616234355434" style="zoom: 50%;" />

1. 源端口、目的端口：应用程序端口号

2. 序号：每一个字节都是编号的；

3. 确认号：B收到A发来的数据，序列号501， 长度200，就表明B正确收到了A 发送到700为止的数据。

   > 确认号为N，就表名N -1 都已准确收到 

4. 数据偏移
5. 保留
6. 紧急
7. **确认ACK** ：ACK = 1有效，ack = 0 无效。tcp连接规定，建立连接后，ack 都必须置为1.
8. 推送
9. 抚慰
10. **同步SYN**：SYN = 1 且ACK = 0 ，表示这是一个连接请求，若对方同意连接，则响应报文SYN =1 ，ACK =1. 
11. **终止FIN** ：释放连接，FIN = 1 表示释放连接
12. **窗口** ： 表示像现在允许对方发送的数据量，其经常动态变化。
13. 检验和：

时间戳：用来计算往返时间，计算通道利用率；同时避免序号重复，因为tcp包围只有32位，且循环使用的。

### TCP 流量控制

 所谓的流量控制就是让发送方的发送速率不要太快，让接收方来得及接受。 当接收方B 的接收数据后，要向发送方发送剩余缓存空间，但是这条消息丢失后，发送方A就无法收到接收方的非零窗口，这时候需要等待，但B一直等待A发送新信息。这时候两者一直循环等待，出现死循环。引入计时器。当收到一个非零通知，就开始计时，时间到期后，就发送一个**零数据的探测窗口**。 

持续计时器 ：避免相互等待死锁。

TCP报文段发送时机：

  1）TCP维持一个变量，它等于最大报文段长度MSS，只要缓存中存放的数据达到MSS字节就组装成一个TCP报文段发送出去。

   2）由发送方的应用程序指明要求发送报文段，即TCP支持的推送操作

   3）是发送方的一个计时器期限到了，这时就把当前已有的缓存数据装入报文段发送出去。

避免传输的效率低，引入一个最大传输长度MSS，避免只有一个数据就要进行传输；同理避免接收方只有一点的接收窗口，就告知发送方可以进行发送，规定可用空间达到最大接收空间一半才告知发送方。

### TCP 拥赛控制

当网络可用资源小于传输要用的资源就出现了**拥赛**。由于引发的因素很多，比如某个结点缓存不够，或者某个路由处理不够及时，都会引起，拥赛是一个全局（因为网络传输涉及很多个路由）的概念，相比 流量控制（局部某个主机，端到端），他更加复杂。 

eg：某个结点缓存空间不够，达到该结点数据因空间不足被丢弃，这时候简单的扩大容量，那么上次软件就可以无限的发送数据，但是网络其他的部分速度并没有提高，整个数据并没有加快处理，等待的时间没有减少，这时候上层软件因为之前发送的数据等待超时，不得不重复发送，造成该结点的存储空间浪费。

如果说提升某一个结点的处理速度，但其他结点处理速度没有提升，整个传输线路拥堵的情况并没有改善。



![image-20200623221826995](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg2l30pmowj31400u04qp.jpg)



负载：单位时间输入给网络的分组数目。吞吐量：单位时间从网络输出的分组数目。

由于网络是一个动态的，所以设计一个方案控制拥赛很难的，但其主要指标是：因缓存空间不够而被丢弃的分组数；平均队列长度，超时重传的分组数，时延等等。

#### 解决方案

慢开始、拥赛避免、快重传、快恢复四种方法。

慢开始和拥撒避免：

当发送方监测到了发生了拥赛（是否出现超时），就减少发送量，否则，就加大发送量；刚开始的时候就用一个比较小的发送量，随着发送接收的轮次增加，这样最后就会达到一个相对适当的发送量，这就是整体的一个思路。



## TCP 连接

即三次握手、四次挥手——就是说的TCP 连接。

![image-20200623225442952](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg2m4nk1xsj31400u07wh.jpg)



A client ： 请求连接 SYN 置为1 ，seq = x（小写表示表示报文序列号），A的状态为 SYN-send；

B server ： 收到A的连接请求，如果同意连接，则ACK = 1、SYN = 1 ，同时附上自己的序列号 seq =y，确认号 ack = x + 1（因为要消耗一个序列号，所以加1）；B的状态为 SYN-receive 

A client：A 收到B的确认后，还要给出B确认，这时候自己的ACK 也要置为 1 ，确认号 ack = y + 1 ，序列号seq = x + 1.

> A为啥还要发送确认报文呢？
>
> 防止已经失效的连接传到了B，这时候会产生错误。即A发送了一个请求连接a0，但由于网络原因a0存在网络中一直未到达B，A又发送了一个请求连接a1，然后二者建立了连接。如果这时候a0突然到达了B，如果没有确认，这时候就会出错，有了确认，这时候A不给B确认，那这个连接就会失效。



### 释放连接

![image-20200623230812187](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg2miou8otj31400u0b29.jpg)



A ：发送FIN = 1 ，seq = u（u等于最后一个字节的序列号加1），进行FIN-wait1 等待状态；

B ：收到A 断开请求，答应断开，于是ACK = 1；确认序列号ack = u + 1；并附上自己的序列号 seq = v；B 处于 close-wait （半关闭状态，此时A 到B方向的连接已经断开 ），这是TCP 要向上层的应用层告知，A已经没有数据发送了，应用程序是否还有新的数据给A没有。若B向A发送数据，A仍然要接收。

A ：收到B的确认报文后，A处于FIN-Wait2状态；

B：若B没有数据给A，那么A就断开连接，这时就必须使用FIN = 1， ACK = 1 告诉A 我和你断开。这是ack = u + 1， seq = w （这里seq变化了，可能这期间B又向A发送了数据，所以两次seq不一样），此时B就是Last-ACK 确认状态

A ：收到B的连接释放报文后，也要发送确认报文给B，此时 ACK =1 ，seq = u + 1， ack = w+1（这里没有FIN，因为第一次已经发送断开请求了）；自己进入time -wait 状态。

B ：当收到A的确认后，B就进入close状态，但A还要经过2MSL的等待时间，为啥呢？有可能自己的确认报文丢失，这样B就会重新发送FIN + ACK 报文，这样A 有机会再次收到B的断开报文，并重新发送确认报文，所以经过这个时间后，A才断开。

**经常会问为啥要四次？比握手多在哪一个环节**

就是B要询问上层的应用软件还要消息发送给A 没有，这个过程会耗时的，但要快速回复A的请求，所以先给一次确认报文，在给出自己的断开请求报文FIN ；

**为啥A发送了确认报文，不能立即断开**

简单来说，就是B在发送FIN+ACK后，要收到A确认，才能断开。所以A在发送确认后，，必须等 2个MSL 时间，这期间没有收到B的消息，就认为B收到了，这样才断开。有可能这个确认报文不会到达B，经过等待一个MSL后，B仍然没有收到确认，B会重新发FIN+ACK，所以这时候A不能关闭。

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghiqjo41omj31400u0x6p.jpg" alt="image-20200808005651851" style="zoom: 67%;" />

**MSL最长报文段寿命：它是任何报文在网络上存在的最长的最长时间，超过这个时间报文将被丢弃。**

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gg2n8q3y8zj30u0140b29.jpg" alt="image-20200623233313735" style="zoom:50%;" />

# 应用层

## DNS 域名解析系统

定义：把域名转换为ip地址 ，即把 www.baidu.com  这种域名转化为相应的ip地址。

为啥计算机不直接使用域名而要使用ip？因为ip 地址长度固定，ipv4 32位。ipv6 128位。而使用域名是为了使用者方便记忆和识别，仅仅二进制码对使用者很不方便。

某个进程需要把主机解析为ip地址是，就调用解析程序。把待解析的域名放入DNS 请求报文中，以UDP的形式发送给本机DNS，DNS就开始解析，若查找不到就去连接远程服务器，然后在返回结果。

### 域名服务器

<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1giqi7hzex2j31400u07wh.jpg" alt="image-20200625004537149" style="zoom:67%;" />



跟域名服务器： 13台，跟域名服务器知道所有的顶级域名服务器；

顶级域名：负责管辖所有的二级服务器；

权限域名：负责某个区域的域名；

本地域名：本地DNS一般是指你电脑上网时IPv4或者IPv6设置中填写的那个DNS。这个有可能是手工指定的或者是DHCP自动分配的。
如果你的电脑是直连运营商网络，一般默认设置情况下DNS为DHCP分配到的运营商的服务器地址。（注意：这里的本地不一定是说电脑本地，而是整个局域网内的概念，包含你的主机和同一网络下的主机及服务器，所以不要混淆了。）

当进程发送ip到DNS 后，DNS 首先去本地域名服务器去解析，解析不到就去**跟服务器**，跟服务器要么告诉结果，要么告诉本地服务器要去请求哪个顶级域名，如果顶级域名没有找到，就会告诉本地服务器去哪个权限域名服务器请求。这时候权限域名最终告诉其结果。

第一，主机向本地域名服务器的查询一般都是采用递归查询（recursive query）；第二，本地域名服务器向根域名服务器发出查询通常是采用迭代查询 （iterative query）



![image-20200625010208242](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg3vfq3nb1j30u0140kjl.jpg)



上面描述了递归或者迭代的方式去查询ip ；实际中，可以使用缓存简化步骤，比如之前是否请求过某个域名，有的话直接使用其上次请求的地址**（这个地址是顶级域名地址，而不是目的域名对应的ip）**，这样请求的时候也不必每次都必须从跟域名开始请求，可以从顶级域名开始，减少网络负荷。

==[面试题：输入网址到展示信息经历了哪些过程](https://blog.csdn.net/qq_24147051/article/details/81115806)==

### 万维网 web

万维网就是通常所说的web，要解决以下问题：

1. 如何标记整个互联网的文档？
2. 什么协议实现各种连接



#### URL

统一资源定位符url 就是一种唯一地址的标识符，其记法：

**协议：//主机.端口/路径** 

eg http://www.baidu.com/index.html  （不区分大小写）

这里省略了默认端口80 ，这里采用的是http 协议，该协议采用的运输层协议是面向连接的tcp，而http协议本身是无状态的，无连接的。

从浏览器请求一个服务器，整个流程和时间估算为：

![image-20200626181327921](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg5uv1qixaj31400u07wh.jpg) 



从图中看到 在tcp 的第三次握手时，客户端携带请求报文给服务器，然后收到请求后做出回答。这期间有2个RTT时间。RTT的意思是也就是说仅包括请求访问来回的时间。后面的精确定义是：

RTT=传播时延（往返）+排队时延（路由器和交换机的）+数据处理时延（应用程序的）

如果每次连接都要进行握手在进行传输，导致开销很大，故http1.1 采用了**持续连接**，就是一个连接建立后，在规定时间内再次访问服务器，都不需要再次建立连接。

### http 报文结构

![image-20200626182234264](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg5v4f9ktxj31400u07wh.jpg)

报文（请求和响应）都有三部分：开始行、首部行、实体主体

开始行：区分响应（状态行）还是请求（请求行）。

首部行：说明浏览器和服务器及报文主体的一些信息

实体主类

#### 请求行

![image-20200626182804493](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg5va585yrj30oe0c0tbk.jpg)

请求行：包含方法（get、post）、请求资源url、版本

请求头：就是包含请求长度、编码方式、使用的浏览器、是否常连接、主机名（接上请求行的请求资源url就是整个url）

请求实体：没有什么东西

#### 响应报文

![image-20200626183356835](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg5vga6jtrj310s0eawke.jpg)

其实和请求报文差不多，不过状态行的 分为 状态码 描述 版本；

### DHCP

就是采用UDP 协议发送报文请求DHCP服务器给一个动态IP地址，然后自己使用的过程。



# 网络安全

运输层安全问题？

补充知识：应用程序如何和运输层打交道？这是靠的操作系统提供的 socket 套接字编程api实现的，这样才能进行信息的转化，所以应用程序信息需要一次转换。而我们在网络中进行传输信息，也要进行信息转换，这时候需要保证安全，就是在这个转换过程中有套了一层，经过了SSL（secture socket layer 安全套接字） 的应用程序的转换，其原理图如下：

![image-20200626193603460](https://tva1.sinaimg.cn/large/007S8ZIlgy1gg5x90a2daj31400u04qp.jpg)



当建立好==tcp连接后==，完成加密算法的协商和会话密钥的传输，在进行数据的传输，其流程如下：

1. **协商加密算法**：
   -  浏览器A 向服务器B 发送自己的SSL版本号及支持的算法；
   - B从中选择自己支持的算法并告诉A
2. 服务器鉴别
   - B 向 A发送自己的数字证书
   - A 使用该证书机构公布的公钥对B的证书进行验证
3. 会话密钥
   - A 产生一个随机数，并用B的公钥加密发送B
   - B 根据刚刚协商的算法产生共享的对称的会话密钥
4. 数据安全传输：
   - A和B 用会话密钥来进行加密和解密

